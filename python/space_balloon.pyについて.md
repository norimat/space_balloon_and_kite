# space_balloon.pyについて

## 変更履歴

| 日付 | 変更概要 |
|-----------------------------------------------|--------------------|
| 2025/05/04 | 新規作成 |
|  |  |

## 1. space_balloon.py概要

### 1-1. 機能概要

space_balloon.pyは以下機能を提供する。
センサーからデータを取得しcsv形式で出力する機能。
センサーから取得したデータを解析し加工する機能。

### 1-2. クラス構成

space_balloon.pyのクラス構成を以下に示す。

<img src="fig/Class_structure.svg" width= "900px" >

| クラス名                   | 説明                                                              |
|---------------------------|-------------------------------------------------------------------|
| `SensorWrapper`クラス      | 入力オプションによってモード別動作を管理する。                        |
| `CameraModuleImpl`クラス   | カメラモジュールから動画を取得するためlibcamera-vidコマンドを実行する。|
| `BME280Impl`クラス         | BME280から温度、気圧および湿度を取得しcsvに出力する。                 |
| `MPU6050Impl`クラス        | MPU6050から加速度、角速度および温度を取得しcsvに出力する。            |
| `MPU9250Impl`クラス        | MPU9250から加速度、角速度および地磁気を取得しcsvに出力する。          |
| `SensorAnalyzerImpl`クラス | 各センサーから取得したデータを解析し加工データを出力する。             |

### 1-3. 入出力

space_balloon.pyは実行開始時および実行中に有効機能に応じて以下を入力とする。

- モード選択
- 機能イネーブル
- 機能別パラメータ
- 出力格納先
-  センサー計測データ

次に実行結果として以下を出力する。

- センサー計測データ
- センサー計測加工後データ

#### 1-3-1. 実行オプション

前述した入力は実行オプションで設定する。
以下にオプション一覧を示す。

| オプション                                | 説明                                               |
|------------------------|----------------------------------------------------------------------|
|`--help`                                  ||
|`--mode <モード番号>`                      |例: ``|
|`--output_dir <出力先ディレクトリ名>`       |例: ``|
|`--camera`                                ||
|`--bme280`                                ||
|`--mpu6050`                               ||
|`--mpu9250`                               ||
|`--framerate <フレームレート>`             |例: ``|
|`--bitrate <ビットレート>`                 |例: ``|
|`--width <水平サイズ>`                     |例: ``|
|`--height <垂直サイズ>`                    |例: ``|
|`--bme280_addr <BME280のデバイスアドレス>`  |例: ``|
|`--mpu6050_addr <MPU6050のデバイスアドレス>`|例: ``|
|`--frame_sync`                             ||
|`--movie_csv <動画のcsvファイル>`           |例: ``|
|`--bme280_csv <BME280のcsvファイル>`        |例: ``|
|`--mpu6050_csv <MPU6050のcsvファイル>`      |例: ``|
|`--mpu9250_csv <MPU9250のcsvファイル>`      |例: ``|
|`--mp4`                                    ||
|`--altitude`                               ||
|`--bme280_graph`                           ||
|`--mpu6050_graph`                          ||
|`--mpu9250_graph`                          ||
|`--movie <動画ファイル名>`                  |例: ``|
|`--tolerance <許容誤差>`                   |例: ``|
|`--excel`                                 ||

#### 1-3-3. csvファイルおよびDataFrame

csvファイルについてセンサー取得モード時はオプションで有効設定にしたセンサーから取得したデータを出力する。センサーデータ解析モードでは解析対象をオプションで設定し、それに応じて加工したcsvを出力する。
また、Excelでの出力オプションを有効にすることで、Excelファイルとして出力可能。
後述する[1-4. 動作モード](#1-4-動作モード)にcsvの形式を示している。

#### 1-3-2. 動画ファイル

動画ファイルについてセンサー取得モード時はカメラモジュールから取得したデータをもとに動画を出力する。一方、センサーデータ解析モードは加工した動画を出力する。加工には読み込んだcsvファイルから取得したデータを動画に埋め込む。

以下は、カメラモジュールから取得したデータを表している。
(※一部別ソフトウェアを通してぼかしをいれている。)

<img src="fig/Photo_captured_using_a_camera module.svg" width= "500px" >

以下は、カメラモジュールの出力csvおよび他センサーデータ計測データをカメラモジュールから取得したデータに埋め込んだ結果を表している。

<img src="fig/Frame_from_an_edited_video.svg" width= "500px" >

<img src="fig/An_image_with_embedded_measurement_results.svg" width= "500px" >


### 1-4. 動作モード

#### 1-4-1.センサー取得モード

センサー取得モードでは、オプションに応じて以下を取得する。
- カメラモジュールからH264フォーマットの動画
- 動画の1フレーム毎のタイムスタンプ
- BME280の計測温度、気圧および湿度
- MPU6050の計測加速度、角速度および温度

##### 1-4-1-1. 動画取得

以下はカメラモジュールの出力csvは以下で、*センサー取得モード*時に出力する。
先頭行にカメラモジュールバージョンがログ説明が必ず入る。
なお、後述する[4. カメラモジュールを用いた動画取得について](#4-カメラモジュールを用いた動画取得について)の[4-3. Pythonコードの説明](#4-3-pythonコードの説明)に記載してあるように、libcamera-vidのオプションで出力するログの形式となる。
このcsvはlibcamera-vidで撮影した動画における1フレームあたりの撮影時間をミリ秒で表している。

```text
# timecode format v2
               0.000
              33.327
              66.655
              99.981
             133.308
                 ...
            6032.182
            6065.511
            6098.837
            6132.164
            6165.490
```

##### 1-4-1-2. BME280計測データ取得

以下はBME280の出力csvは以下で、*センサー取得モード*時に出力する。
- elapsed_timeは初回計測開始からの経過時間を秒単位で表している。
- start_epoch_timeは初回計測開始時刻のUNIXエポックタイムを表している。
- unix_epoch_timeはcsv出力可能時刻のUNIXエポックタイムを表している。
- temperatureはBME280から取得した温度、pressureは気圧、humidityは湿度を表している。

```text
elapsed_time  start_epoch_time  unix_epoch_time  temperature    pressure   humidity
    0.021416      1.745854e+09     1.745854e+09    28.675836  998.101465  39.258262
    0.041374      1.745854e+09     1.745854e+09    28.680888  998.030453  39.078561
    0.062080      1.745854e+09     1.745854e+09    28.690990  998.101007  38.806262
    0.082345      1.745854e+09     1.745854e+09    28.690990  998.074434  38.768136
    0.102556      1.745854e+09     1.745854e+09    28.685939  998.039157  39.231050
         ...               ...              ...          ...         ...        ...
    8.797503      1.745854e+09     1.745854e+09    28.766757  998.018973  38.931588
    8.818225      1.745854e+09     1.745854e+09    28.751604  998.019438  38.779058
    8.838896      1.745854e+09     1.745854e+09    28.766757  998.045549  38.969718
    8.859625      1.745854e+09     1.745854e+09    28.756655  998.081292  39.018731
    8.880499      1.745854e+09     1.745854e+09    28.751604  998.125739  39.726741
```

##### 1-4-1-3. MPU6050計測データ取得

以下はMPU6050の出力csvは以下で、*センサー取得モード*時に出力する。
- elapsed_timeは初回計測開始からの経過時間を秒単位で表している。
- start_epoch_timeは初回計測開始時刻のUNIXエポックタイムを表している。
- unix_epoch_timeはcsv出力可能時刻のUNIXエポックタイムを表している。
- ax、ayおよびazはMPU6050から取得した加速度を表している。
- gx、gyおよびgzはMPU6050から取得した角速度を表している。
- temperatureはMPU6050から取得した温度を表している。

```text
elapsed_time  start_epoch_time  unix_epoch_time        ax        ay        az        gx        gy        gz  temperature
    0.009498      1.745854e+09     1.745854e+09  0.351196 -0.060059  0.898926 -0.900763 -0.404580 -6.946565    31.202941
    0.016580      1.745854e+09     1.745854e+09  0.351196 -0.058350  0.898682 -0.954198 -0.450382 -6.908397    31.217647
    0.025280      1.745854e+09     1.745854e+09  0.352661 -0.054321  0.897217 -0.984733 -0.427481 -7.061069    31.214706
    0.032365      1.745854e+09     1.745854e+09  0.350098 -0.060059  0.895630 -1.007634 -0.564885 -7.160305    31.205882
    0.038829      1.745854e+09     1.745854e+09  0.348267 -0.058716  0.898438 -1.083969 -0.549618 -7.229008    31.200000
         ...               ...              ...       ...       ...       ...       ...       ...       ...          ...
    8.856019      1.745854e+09     1.745854e+09  0.353149 -0.058105  0.893433 -1.068702 -0.557252 -6.984733    31.232353
    8.865768      1.745854e+09     1.745854e+09  0.353027 -0.059204  0.895630 -1.145038 -0.511450 -7.053435    31.250000
    8.873570      1.745854e+09     1.745854e+09  0.350464 -0.057861  0.898926 -1.091603 -0.473282 -7.122137    31.255882
    8.883144      1.745854e+09     1.745854e+09  0.351685 -0.058472  0.900635 -1.213740 -0.534351 -7.175573    31.229412
    8.891014      1.745854e+09     1.745854e+09  0.352417 -0.058472  0.897705 -1.175573 -0.534351 -7.137405    31.241176
```

##### 1-4-1-4. MPU9250計測データ取得

MPU9250は生産終了に伴い未実装となっている。

#### 1-4-2.センサーデータ解析モード

センサーデータ解析モードでは、オプションに応じて以下を取得する。
- カメラモジュールからH264フォーマットの動画
- 動画の1フレーム毎のタイムスタンプ
- BME280の計測温度、気圧および湿度
- MPU6050の計測加速度、角速度および温度

#### 1-4-3.モード別クラスデータパス

センサー取得モード時は以下のデータパスで動作する。

<img src="fig/Sensor_Data_Acquisition_Mode_Operation.svg" width= "700px" >

センサーデータ解析モード時は以下のデータパスで動作する。

<img src="fig/Sensor_Data_Analysis_Mode_Operation.svg" width= "700px" >

##### 1-4-2-1. 高度の算出

以下は*センサーデータ解析モード*時に出力する、BME280計測結果を加工したcsvである。
*センサー取得モード*時に出力したcsvに高度を追加している。
- current_timeは、BME280から*センサー取得モード*時に取得したunix_epoch_timeを日時・時刻形式にした結果を表している。
- altitudeは、BME280*センサー取得モード*時に取得した温度、気圧および湿度をもとに算出した高度を表している。

なお、高度の算出は後述する[5-2. 高度の算出方法について](#5-2-高度の算出方法について)に示す。

```text
elapsed_time  start_epoch_time  unix_epoch_time             current_time  temperature    pressure   humidity    altitude
    0.021416      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.168    28.675836  998.101465  39.258262  132.894387
    0.041374      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.188    28.680888  998.030453  39.078561  133.523423
    0.062080      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.209    28.690990  998.101007  38.806262  132.905097
    0.082345      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.229    28.690990  998.074434  38.768136  133.139654
    0.102556      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.249    28.685939  998.039157  39.231050  133.448827
         ...               ...              ...                      ...          ...         ...        ...         ...
    8.797503      1.745854e+09     1.745854e+09  2025-04-29 00:22:02.944    28.766757  998.018973  38.931588  133.662778
    8.818225      1.745854e+09     1.745854e+09  2025-04-29 00:22:02.965    28.751604  998.019438  38.779058  133.651959
    8.838896      1.745854e+09     1.745854e+09  2025-04-29 00:22:02.985    28.766757  998.045549  38.969718  133.428124
    8.859625      1.745854e+09     1.745854e+09  2025-04-29 00:22:03.006    28.756655  998.081292  39.018731  133.108075
    8.880499      1.745854e+09     1.745854e+09  2025-04-29 00:22:03.027    28.751604  998.125739  39.726741  132.713458
```

##### 1-4-2-2. BME280から取得したデータのグラフ作成機能

matplotlibライブラリで出力するようにする予定だが、今回は未実装となっている。

##### 1-4-2-3. MPU6050から取得したデータのグラフ作成機能

matplotlibライブラリで出力するようにする予定だが、今回は未実装となっている。

##### 1-4-2-4. MPU9250から取得したデータのグラフ作成機能

matplotlibライブラリで出力するようにする予定だが、今回は未実装となっている。

##### 1-4-2-5. 動画データとセンサーデータの同期

以下は*センサーデータ解析モード*時に出力する、カメラモジュールの出力csvおよびBME280計測結果をマージしたcsvである。
- current_timeは、カメラモジュールの出力csvから*センサー取得モード*時に取得したunix_epoch_timeを日時・時刻形式にした結果を表している。
- マージデータはBME280の*センサー取得モード*時のcsvから抽出し、unix_epoch_timeが近いデータを表している。
  - 近いデータの抽出には、--toleranceオプションで指定した許容差分範囲以内のデータを抽出する。
  - --toleranceオプションで指定した許容差分に収まるデータが無い場合計測データがないと判断し空欄となる。
- bme280_unix_epoch_time_deltaはカメラモジュールの出力csvおよびBME280の*センサー取得モード*時のcsvにおけるunix_epoch_timeから差分を表している。
  - 例えば、bme280_unix_epoch_time_deltaが0.001412であると、カメラモジュールから取得した時刻とBME280からデータを取得した時刻は1.4msecの時間差があることを表している。

なお、今回の例はBME280だが、MPU6050など他センサーの計測結果もマージ可能である。

```text
milli_sec_elapsed_time  sec_elapsed_time  unix_epoch_time             current_time  bme280_elapsed_time  ...  bme280_unix_epoch_time  bme280_temperature  bme280_pressure  bme280_humidity  bme280_unix_epoch_time_delta
                 0.000          0.000000     1.745854e+09  2025-04-29 00:21:55.150             1.001782  ...            1.745854e+09           28.721297       997.993792        38.740915                      0.001412
                33.327          0.033327     1.745854e+09  2025-04-29 00:21:55.183             1.045655  ...            1.745854e+09           28.721297       998.020366        38.986017                      0.009134
                66.655          0.066655     1.745854e+09  2025-04-29 00:21:55.216             1.067328  ...            1.745854e+09           28.716246       998.038235        39.209310                      0.002522
                99.981          0.099981     1.745854e+09  2025-04-29 00:21:55.250             1.109899  ...            1.745854e+09           28.726348       998.082217        38.659212                      0.006723
               133.308          0.133308     1.745854e+09  2025-04-29 00:21:55.283             1.131053  ...            1.745854e+09           28.721297       998.073513        39.040482                      0.005450
                   ...               ...              ...                      ...                  ...  ...                     ...                 ...              ...              ...                           ...
              6032.182          6.032182     1.745854e+09  2025-04-29 00:22:01.182             7.042190  ...            1.745854e+09           28.751604       998.072588        38.697348                      0.006813
              6065.511          6.065511     1.745854e+09  2025-04-29 00:22:01.215             7.063206  ...            1.745854e+09           28.736450       998.019902        39.242017                      0.005499
              6098.837          6.098837     1.745854e+09  2025-04-29 00:22:01.249             7.104738  ...            1.745854e+09           28.741502       998.002031        38.958802                      0.002707
              6132.164          6.132164     1.745854e+09  2025-04-29 00:22:01.282             7.125377  ...            1.745854e+09           28.746553       998.037310        38.604742                      0.009982
              6165.490          6.165490     1.745854e+09  2025-04-29 00:22:01.315             7.166440  ...            1.745854e+09           28.756655       998.054717        38.294218                      0.002244
```

## 2. 動作環境

計測はRaspberry Pi Zero 2 W、計測結果の加工はRaspberry Pi 4Bを使用する。
それぞれのスペックについては[付録](#付録)の[Raspberry Piのスペック表](#Raspberry-Piのスペック表)に記載している。
OSはRaspberry Pi OSでDebinanベースのディストリビューションバージョンBullseyeを使用する。

## 3. 実行方法

実行にはモードを選択し*センサー取得モード*または*センサーデータ解析モード*を選択する。
また有効にしたいセンサーを選択し実行する。

*センサー取得モード*でカメラ、BME280およびMPU6050を有効にし各デバイスアドレスを指定した上で、出力結果格納先を指定した実行例は以下となる。

```text
$ python space_balloon.py   \
       --mode 0             \
       --camera             \
       --bme280             \
       --bme280_addr 0x76   \
       --mpu6050            \
       --mpu6050_addr 0x68  \
       --output_dir ./output
```

*センサーデータ解析モード*でカメラ、BME280およびMPU6050を取得結果を指定し、高度算出および動画データに同期した計測結果を生成するための実行例は以下となる。

```text
$ python space_balloon.py                                     \
        --mode 1                                              \
        --frame_sync                                          \
        --altitude                                            \
        --movie       ./output/video_1745853715.150165.h264   \
        --movie_csv   ./output/video_1745853715.1501062.csv   \
        --tolerance   0.015                                   \
        --bme280_csv  ./output/bme280_1745853714.1328616.csv  \
        --mpu6050_csv ./output/mpu6050_1745853714.1328616.csv
```

## 4. カメラモジュールを用いた動画取得について

カメラモジュールはv2およびv3での2種類で撮影可能である。
v2かv3でPythonスクリプトの差分は発生しないが、今回はv2で撮影した場合の説明で記載する。

### 4-1. センサー取得モード時の動画ファイルおよび出力csvファイル

[1-3-3. csvファイルおよびDataFrame](#1-3-3-csvファイルおよびdataframe)に示すようなcsvファイルを出力する。

### 4-2. Pythonコードの説明

カメラモジュールを用いて撮影し動画を出力するには、libcamera-vidコマンドで取得できる。
Pythonのコードでは以下のようにlibcamera-vidを呼び出している。

```py
    def __start_camera_module( self ):
        time.sleep(1)
        subprocess.run(
            "libcamera-vid --framerate "    + str( self.__framerate) +
            " --bitrate "                   + str( self.__bitrate ) +
            " --width "                     + str( self.__width ) +
            " --height "                    + str( self.__height ) +
            " --save-pts "                  + str( self.__csvFilePath ) + "/video_"
            + str(time.time()) + ".csv -o " + str( self.__csvFilePath ) +"/video_"
            + str(time.time()) +".h264 --timeout 0 --nopreview",
            shell          = True ,
            capture_output = True ,
            text           = True
        )
```

libcamera-vidの呼び出ではオプションで以下を指定している。
- --framerate：撮影時のフレームレート設定
- --bitrate：撮影時のビットレート設定
- --width：撮影時に水平サイズ
- --height：撮影時に垂直サイズ
- --save-opt：フレーム毎のタイムスタンプをミリ秒単位で出力する設定
- -o：出力先動画ファイル名
- --timeout：タイムアウト時間をミリ秒で設定(0にすることで無制限)
- --nopreview：GUIで撮影プレビューを表示しなくする設定

例えば、30fpsでFullHDの動画を無制限に出力する実行コマンドの例は以下となる。
なお、FullHDの適正ビットレートは一般的に4\~8Mbpsとされている。

```text
$ libcamera-vid --framerate 30 --bitrate 8000000 \
  --width 1920 --height 1080 --save-pts sample.csv -o video.h264 \
  --timeout 0 --nopreview
```

## 5. BME280を用いた高度算出について

### 5-1. BME280について

BME280で計測可能なデータは以下である。

| 気圧                                          | 温度               | 湿度                |
|-----------------------------------------------|-------------------|---------------------|
| 単位:ヘクトパスカル(hPa)                       | 単位:℃(摂氏)       | 単位:%(RH)          |
| 計測範囲:300\~1100hPa<br>(標高換算-500~+9000m) | 計測範囲:-40\~+85℃ | 計測範囲:0%\~100%RH |

### 5-2. 高度の算出方法について

高度を求める場合、気圧から算出可能である。
高度の算出には、パラメトリック方程式または等温パラメトリック方程式を使用する。

#### 5-2-1. パラメトリック方程式について

パラメトリック方程式は対流圏といった0km~11kmの範囲で使用する方程式。
成層圏以上では誤差が大きくなる。
理由として、気温が一定の割合で低下すると仮定しているが、成層圏では気温が上昇するためである。

<!--------------------------------------------------------------------------------->

```math
h=
\left( \frac{T}{L} \right)
\left( 1-\left( \frac{P}{P_0} \right)^{\!\!\frac{RL}{gM}} \right)
```

```math
h:高度[m]\hspace{0pt}
```

```math
T:仮想温度または実測温度 [K]\hspace{0pt}
```

```math
L:温度減率(0.0065[K/m])\hspace{0pt}
```

```math
P:測定地点の気圧[hPa]\hspace{0pt}
```

```math
P_0:海面上の標準気圧(1013.25[hPa])\hspace{0pt}
```

```math
R:気体定数(8.314462618[J/(mol·K)])\hspace{0pt}
```

```math
g:重力加速度(9.80665[m/s^2])\hspace{0pt}
```

```math
M:空気のモル質量(0.0289644[kg/mol])\hspace{0pt}
```

<!--------------------------------------------------------------------------------->

#### 5-2-2. 等温パラメトリック方程式について

成層圏といった11km~20kmの範囲で使用する方程式。
成層圏では温度が一定なため、パラメトリック方程式より誤差を抑えられる。

```math
h=11000+\frac{RT}{gM}×ln\left( \frac{P_u}{P} \right)
```

```math
h:高度[m]\hspace{0pt}
```

```math
R:気体定数(8.314462618[J/(mol·K)])\hspace{0pt}
```

```math
T:仮想温度または実測温度 [K]\hspace{0pt}
```

```math
g:重力加速度(9.80665[m/s^2])\hspace{0pt}
```

```math
M:空気のモル質量(0.0289644[kg/mol])\hspace{0pt}
```

```math
P_u:層の下端の気圧(約22632Pa[hPa]\ 11km)\hspace{0pt}
```

```math
P:測定地点の気圧[hPa]\hspace{0pt}
```

<!--------------------------------------------------------------------------------->

#### 5-2-3. 湿度を用いた仮想温度について

湿度を考慮しするため仮想温度を算出することで、高度の算出精度を向上できる。
湿度が高いと空気密度が変化し高度の算出精度が変わるため、湿度を考慮し精度を上げることが可能。
仮想温度を求める上で、混合比、水蒸気圧および飽和水蒸気圧をを用いて求める。

<!--------------------------------------------------------------------------------->

##### 5-2-3-1. 仮想温度(Virtual Temperature)

仮想温度は湿度を考慮し、乾燥空気の密度と等しい密度を持つ理想気体の温度として定義する。
空気が湿っていると密度が下がるため、温度を高く見積もる。
仮想温度は以下式で求める。

```math
T_v=T×\left( 1+0.61×r \right)
```

```math
T_v:仮想温度[K]\hspace{0pt}
```

```math
r:混合比[kg/kg]\hspace{0pt}
```

##### 5-2-3-2. 混合比(Mixing Ratio)

混合比は乾いた空気1gに対して何gの水蒸気が含まれているかを表す。
0.622は水蒸気と乾燥空気の分子量比。

```math
r=\frac{\frac{0.622×e}{P-e}}{1000}
```

```math
r:混合比[kg/kg]\hspace{0pt}
```

```math
e:実際の水蒸気圧[hPa]\hspace{0pt}
```

```math
P:測定地点の気圧[hPa]\hspace{0pt}
```

##### 5-2-3-3. 水蒸気圧(Vapor Pressure)

実際の空気中の水蒸気圧力は以下の式で求める。
湿度が100%である時eは飽和水蒸気圧の値となり、それ以下の場合は比例して小さくなる。

```math
e=e_s×\left( \frac{RH}{100} \right)
```

```math
e:実際の水蒸気圧[hPa]\hspace{0pt}
```

```math
e_s:飽和水蒸気圧[hPa]\hspace{0pt}
```

```math
RH:実測湿度[\%]\hspace{0pt}
```

<!--------------------------------------------------------------------------------->

##### 5-2-3-4. 飽和水蒸気圧(Saturation Vapor Pressure)

空気は気温が高いほど空気はより多くの水蒸気を保持できる。
飽和水蒸気圧は近似式(Tetensの式)を用いて求められる。
以下に式を示す。

```math
e_s=6.112×exp\left( \frac{17.67×T_c}{T_c-243.5} \right)
```

```math
e_s:飽和水蒸気圧[hPa]\hspace{0pt}
```

```math
T_c:実測温度[℃]\hspace{0pt}
```

<!--------------------------------------------------------------------------------->

### 5-3. Pythonコードの説明

高度算出は以下関数で実施している。
なお、Tc、RH、Pはそれぞれセンサーデー計測した温度、湿度、気圧となっている。

```py
    def __calculate_altitude( self , Tc , RH , P ):
        P0  = 1013.25     # 海面上の標準気圧[hPa]
        L   = 0.0065      # 温度減率[K/m]
        g   = 9.80665     # 重力加速度[m/s^2]
        R   = 8.314462618 # 気体定数[J/(mol·K)]
        M   = 0.0289644   # 空気のモル質量[kg/mol]
        Pu  = 226.32      # 標準大気における11kmの気圧[hPa]
        if RH is None or RH <= 0: # 湿度データが無い場合は実測温度を使う
            Tu = Tc + 273.15 # [K]
        else:                     # 湿度データがある場合は仮想温度を使う
            Tu = self.__virtual_temperature( Tc , RH , P )
        if P > Pu:                # 対流圏 (11km以下)
            h = (Tu / L) * (1 - (P / P0) ** ((R * L) / (g * M)))
        else:                     # 成層圏 (11km以上)
            h = 11000 + ( R * Tu ) / ( g * M ) * math.log( Pu / P )
        return h
```

以下で湿度を用いた仮想温度を算出している。仮想温度算出には飽和水蒸気圧、水蒸気圧および混合比を算出する必要がある。

```py
    def __virtual_temperature( self , Tc , RH , P ):
        Tk  = Tc + 273.15  # 気温をKに変換
        es  = 6.112 * math.exp( (17.67*Tc) / (Tc+243.5) ) # 飽和水蒸気圧(Tetensの式)es[hPa]
        e   = (RH / 100.0) * es                           # 実際の水蒸気圧e[hPa]
        r   = ((0.622*e) / (P-e)) / 1000                  # 混合比r[kg/kg]
        Tkv = Tk * ( 1 + 0.61 * r )                       # 仮想温度[K]
        return Tkv
```

## 6. MPU6050を用いた加速度および角速度の取得について

### 6-1. MPU6050について

MPU6050で計測可能なデータは以下である。

| x軸加速度・y軸加速度・z軸加速度 | x軸角速度・y軸角速度・z軸角速度 | 温度            |
|------------------------------|-------------------------------|-----------------|
| 単位:g(重力加速度)             | 単位:°/S(度毎秒)               | 単位:℃(摂氏)    |
| ±2g、±4g、±8g、±16g           | ±250、±500、±1000、±2000 °/s  |計測範囲:-40\~+85℃|

### 6-2. Pythonコードの説明

センサーデータの取得はMPU6050Implクラスで実施している。
以下がセンサーからデータを取得する関数である。
\_\_read\_sensor関数では、I2C通信バス上デバイスアドレスのアドレスを指定しデータを取得する。
MPU6050では、デバイス内部で加速度3種、角速度3種および温度と複数のデータをレジスタから読み取る。

```py
    def __read_sensor( self ):
        PWR_MGMT_1a  = 0x6B
        ACCEL_XOUT_H = 0x3B
        ACCEL_YOUT_H = 0x3D
        ACCEL_ZOUT_H = 0x3F
        GYRO_XOUT_H  = 0x43
        GYRO_YOUT_H  = 0x45
        GYRO_ZOUT_H  = 0x47
        TEMP_OUT_H   = 0x41
        self.__bus.write_byte_data( self.__address , PWR_MGMT_1a , 0 )
        self.__ax          =   self.__read_word( ACCEL_XOUT_H ) / 16384.0
        self.__ay          =   self.__read_word( ACCEL_YOUT_H ) / 16384.0
        self.__az          =   self.__read_word( ACCEL_ZOUT_H ) / 16384.0
        self.__gx          =   self.__read_word( GYRO_XOUT_H  ) / 131.0
        self.__gy          =   self.__read_word( GYRO_YOUT_H  ) / 131.0
        self.__gz          =   self.__read_word( GYRO_ZOUT_H  ) / 131.0
        self.__temperature = ( self.__read_word( TEMP_OUT_H ) + 521 ) / 340.0 + 35.0
```

デバイスから取得する際はレジスタのアドレスを指定し、1バイトのデータを2回取得する。
2回目のデータ取得時はレジスタのアドレスを1加算しずらして別レジスタからデータを取得する。
よって、I2C通信バスへのアクセスは2回行われる。
1回目に取得したデータは加速度、角速度または温度のMSBデータである。
このため\_\_read\_word関数ではMSBにデータを詰めるため、8ビット(1バイト)分算術左シフトしている。
(なお、I2C通信バス向けのread_i2c_block_data関数で一括取得し、バス負荷を軽減できることもある。)

```py
    def __read_word( self , addr ):
        high = self.__bus.read_byte_data( self.__address , addr   )
        low  = self.__bus.read_byte_data( self.__address , addr+1 )
        val = (high << 8) + low
        if( val < 0x8000 ):
            return val
        else:
            return val - 65536
```

## 7. MPU9250を用いた加速度、角速度および地磁気の取得について

現在、MPU9250生産終了のためICM20948に以降予定。

## 8. ICM20948を用いた加速度、角速度および地磁気の取得について

ICM20948入手後、実装および動作確認予定。

## 9. センサーから取得する動画およびcsv出力に伴うオーバヘッドの回避

センサーからデータを取得する機能は、`CameraModuleImpl`クラス、`BME280Impl`クラス、`MPU6050Impl`クラスおよび`MPU9250Impl`クラスに実装している。
Pythonで実装した場合のオーバヘッド発生例として、以下が想定される。

### 9-1. 動画処理でのオーバヘッド

動画でセンサーデータを取得しながら30fpsを実現したいとすると1フレーム当たりで、

①PythonのライブラリPicamera2でカメラモジュールからデータを取得

②各センサーライブラリを用いてデータを取得

③OpenCVライブラリで動画として書き込み

④センサー取得データをcsvに書き込み

⑤1秒間で30回①\~④を繰り返す(1フレーム当たり**1秒/30フレーム=0.0333秒**以内で処理をする必要がある。)

といった処理が必要となる。
しかし、Raspberry Pi Zero 2 Wや4で対応しても0.0333秒以内には処理が完了できず、動画が早送りの動画になってしまう。
(OpenCVで動画を書き込みする際に、1秒あたりに必要なフレーム数が足りず早送りになる。)
そこで、センサーの取得タイミングと同期するため、libcamera-vidで動画は30fpsで撮っておき、メタデータ出力機能でタイムスタンプを出力した上で後にセンサーデータの時間と同期を取るようにしている。
これは、libcamera-vidの実行は`CameraModuleImpl`クラスで実装し、後の同期処理は、`SensorAnalyzerImpl`クラスで実施している。
なお、他にもフレームバッファーを実装しマルチスレッドでフレームデータを書き込むことにより動画を作成することで回避可能な可能性もある。
しかし、Pythonで実装した場合Cコードを内部で呼び出し処理するオーバーヘッドによる性能低下やフレームバッファ実装コストがかかることが予想されるため、
今回はより容易に実装でき、センサーアクセス頻度を上げ消費電力の課題が出た場合再度C++での実装検討をすることとした。

なお、DSF2023バルーン企画航空局提出資料付録.xlsxから飛行時間は190分想定とされている。
また、後述する[付録](#付録)の[消費電力の見積り](#消費電力の見積り)に示すように高負荷でも5時間は動作可能なため、
アクセス頻度が高いことによる消費電力対策は実装優先度を下げている。

### 9-2. I2C通信センサーでのオーバヘッド

I2C通信センサーでcsvなどのログファイルに出力する場合、

①Pythonのライブラリセンサーモジュールからデータを取得

②センサー取得データをcsvに書き込み

③1秒間で30回①、②を繰り返す

②の処理については、csvに書き込むオーバヘッドでミリ秒単位の処理でフレームとの同期が難しい。
このため、出力処理はマルチスレッドで実装し、センサーデータが読み込み完了を判定できた後、csvで出力する。

[9-1. 動画処理でのオーバヘッド](#9-1-動画処理でのオーバヘッド)に示したように、動画データと同期を取る場合、以下が想定される。
- n秒毎に同期する
  - n=1の場合、Pythonのtimeライブラリでセンサー取得時刻し、1秒間隔になるよう停止時間を補正計算し、動的にtime.sleep()の処理で待ち時間を設定する方法がある。
  - 今回、1フレーム毎に同期できるようにしたため、この処理は実装していない。
- 1フレーム毎に同期する
  - 1/30=0.0333秒毎にセンサーアクセスし、2/30=0.0666秒、0.1秒、・・・、n/30秒毎にセンサーから取得する必要がある。
  - Pythonでミリ秒単位の処理をtime.sleepで制御しようとすると簡単な処理で多少の誤差が発生するため、待ち時間の補正計算で1フレームに間に合わないことがある。
  - MPU6050のように複数レジスタからデータを取得する場合、アクセス回数が多く補正計算を含めると1フレームデータに間に合わないことがある。
  - 上記理由から、アクセス回数だけに注力するため補正計算は実装せず、アクセス頻度を上げて対応する。
  -　実装は`センサ名ModuleImpl`クラスで実装し、後の同期処理は、`SensorAnalyzerImpl`クラスで実施している。

## 10. 今後の課題
今回はPythonで実装した。しかし、Pythonは内部でCコードを呼び出しセンサーへのアクセスをしている。
このため、センサーアクセスはPythonでなくC/C++コードは直接のセンサーアクセスが可能で高速に処理できることからオーバヘッドを削減しより時間的精度を高く処理ができる。
また、調査によるとカメラモジュールの制御もlibcameraのC++ライブラリによりアクセス可能な可能性がある。
このことから、C++でカメラモジュールおよびセンサー制御を実装することで時間的精度を上げてアクセス可能である。
消費電力の観点からも精度が上がることでカメラモジュールアクセス起点でセンサーアクセスをすることで改善する可能性が高い。

## 付録

### Raspberry Pi OSの確認

以下コマンドでDebinanベースのディストリビューションバージョンを確認可能。
Codenameの欄が該当箇所。
例では、Bullseyeとなっているが、2025/04/30時点で1つ古いバージョンとなっており、最新はBookwormとなっている。
BullseyeとBookwormからカメラモジュールの設定ファイルやIPアドレス固定向けファイルの配置場所が変わっている。
また、libcamera-vidなどで使用可能なオプションも変わってくる。

```text
$ lsb_release -a
No LSB modules are available.
Distributor ID: Raspbian
Description:    Raspbian GNU/Linux 11 (bullseye)
Release:        11
Codename:       bullseye
```

### Python実行環境準備

Python実行環境を分離し管理しやすいように仮想環境を使用する。
これによりバージョンが異なるライブラリや依存関係を使い分けやすくする。

仮想環境は以下コマンドで作成できる。

```text
$ python -m venv python_space_balloon
```

仮想環境は以下コマンドで有効かできる。

```text
$ source python_space_balloon/bin/activate
```

有効化後、space_balloon.pyを実行するために必要なライブラリをインストールする。

```text
$ pip install smbus2
$ pip install FaBo9Axis_MPU9250
$ pip install smbus
$ pip install pandas
$ pip install matplotlib
$ pip install opencv-python
$ pip install openpyxl
$ pip install rpi.bme280
```

FaBo9Axis_MPU9250はpython 2系のコードでprint文がpython 3系で実行できないためコードを編集する。
まず、pythonコマンドを実行し、エラーが以下ファイルで発生するためエディタで編集する。
print文を検索し、python 3系の記述に変更する。

```text
$ emacs python_space_balloon/lib/python3.9/site-packages/FaBo9Axis_MPU9250/MPU9250.py
```
※emacsはviやnanoでも問題ない。

### Sambaの設定

Raspberry Piで何らかの開発をする場合、Window間-Raspberry Piでファイルのやり取りをすることが多々あるかと思われる。
例えば、出力Excelファイルなどの確認で使用する。
この際にネットワーク経由でファイル共有が可能な場合効率が上がることがあるため、ファイル共有設定を説明する。
なお、実際にバルーン打ち上げ時に余計なプロセスが動作していると消費電力に影響があるため不要な場合は動作しないようにした方が良い。

インストールコマンドは以下。

```text
sudo apt-get install -y samba
```

Sambaの設定は/etc/samba/smb.confに追記する。

```text
$ sudo エディタ(vi、emacsやnanoなど) /etc/samba/smb.conf
```

アカウント名は共有したいユーザディレクトリを記載する。

```text
#                                                                                               
# Sample configuration file for the Samba suite for Debian GNU/Linux.                           
#                                                                                               
#                                                                                               
# This is the main Samba configuration file. You should read the                                
# smb.conf(5) manual page in order to understand the options listed                             
# here. Samba has a huge number of configurable options most of which  

                                 省略

# Windows clients look for this share name as a source of downloadable
# printer drivers
[print$]
   comment = Printer Drivers
   path = /var/lib/samba/printers
   browseable = yes
   read only = yes
   guest ok = no
# Uncomment to allow remote administration of Windows print drivers.
# You may need to replace 'lpadmin' with the name of the group your
# admin users are members of.
# Please note that you also need to set appropriate Unix permissions
# to the drivers directory for these users to have write rights in it
;   write list = root, @lpadmin

[アカウント名]
   comment = アカウント名 user file space
   path = /home/アカウント名
   force user = アカウント名
   guest ok = no
   create mask = 0666
   directory mask = 0777
   read only = no
```

### IPアドレスの固定

Raspberry Pi OSがBullseyeおよびRaspberry Pi Zero 2 Wの前提で説明を記載。

現在のIPアドレスは以下コマンドで調べられる。

```text
$ ifconfig
lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (ローカルループバック)
        RX packets 42  bytes 4920 (4.8 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 42  bytes 4920 (4.8 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

wlan0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.0.67  netmask 255.255.255.0  broadcast 192.168.0.255
        inet6 fe80::db06:eca1:833c:e925  prefixlen 64  scopeid 0x20<link>
        inet6 1455b:10:53c0:3e00:bbbd:bd1:f345:a4a4  prefixlen 64  scopeid 0x0<global>
        ether 省略  txqueuelen 1000  (イーサネット)
        RX packets 72780  bytes 9847351 (9.3 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 95607  bytes 53115827 (50.6 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

wlan0がWi-Fiで接続しているインタフェース名でinetがIPv4アドレスとなっている。
ネットマスクは255.255.255.0で24ビットがネットワーク部となっている。
wlan0のIPアドレスを固定する場合は/etc/dhcp.confをエディタで編集する。
以下に、IPアドレスを192.168.0.55に固定するための記述を示す。

```text
$ sudo エディタ(vi、emacsやnanoなど) /etc/dhcp.conf
```

```text
# A sample configuration for dhcpcd.                                                             
# See dhcpcd.conf(5) for details.                                                                

# Allow users of this group to interact with dhcpcd via the control socket.
#controlgroup wheel

# Inform the DHCP server of our hostname for DDNS.
hostname

                    省略

# fallback to static profile on eth0
#interface eth0
#fallback static_eth0

interface wlan0
static ip_address=192.168.0.55/24
static routers=192.168.0.1
```

interfaceのwlan0の箇所が設定となっている。
static ip_addressで固定するIPアドレスを記載する。
/24はサブネットマスクのネットワーク部ビット数を記載する。
static routersはデフォルトゲートウェイ(ルーター)のIPアドレスを記載する。
一般的に1がルーターのIPアドレスになるが、何らかの理由で異なる場合は以下コマンドで調べる。

```text
$ ip route
default via 192.168.0.1 dev wlan0 src 192.168.0.67 metric 302 
192.168.0.0/24 dev wlan0 proto dhcp scope link src 192.168.0.67 metric 302 
```

default via 192.168.0.1がルーターのIPアドレスとなる。

### I2C通信

I2Cは複数のセンサーを2本の信号線(SCL:クロック、SDA:データ)で接続しデータ通信できる。

BME280およびMPU6050はI2Cでデータ通信しそれぞれのデータを取得する。
以下に配線図を示す。

<img src="fig/I2C_connection_diagram.svg" width= "500px" >

i2cdetectコマンドで接続しているデバイスアドレスを確認できる。

```text
$ i2cdetect -y 1

     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:                         -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- 68 -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- 76 --  
```

BME280の端子説明を以下に示す。

| ピン名        | 機能                      | 説明                                                                 |
| ------------ | ---------------           | -------------------------------------------------------------------  |
| **VCC**      | 電源入力                   | センサーに電源を供給する。通常は**3.3V**で駆動する。                    |
| **GND**      | グラウンド                 | 電源のマイナス側(GND)に接続する。                                       |
| **SCL**      | シリアルクロックライン      | I2C通信のクロック信号線。Raspberry PiではGPIO3(物理ピン5)に接続する。    |
| **SDA**      | シリアルデータライン        | I2C通信のデータ信号線。Raspberry PiではGPIO2(物理ピン3)に接続する。      |
| **CSB** 　　　| チップセレクト             | I2Cモードでは **"High"(未接続でも良い)** にする。<br>SPIモードでのみ使用。|
| **SDO**      | アドレス選択またはSPIデータ | I2Cでは、**接地(GND)するとアドレス0x76**、**VCCにするとアドレス0x77** になる。<br>SPIではデータ出力ピンとして使用される。 |

MPU6050の端子説明を以下に示す。

| ピン名   | 機能                 | 説明                                                                     |
| ------- | -----------          | -------------------------------------------------------------------      |
| **VCC** | 電源入力              | 通常**3.3Vまたは5V**で動作(モジュールにより異なる)。                         |
| **GND** | グラウンド            | 電源のマイナス側に接続。                                                   |
| **SCL** | シリアルクロックライン | I2C通信のクロック信号線。Raspberry PiではGPIO3(物理ピン5)に接続。            |
| **SDA** | シリアルデータライン   | I2C通信のデータ信号線。Raspberry Piでは GPIO2(物理ピン3)に接続。             |
| **XDA** | 補助I2Cデータ         | 未使用でよい(センサ同士のデイジーチェーン接続用)。                            |
| **XCL** | 補助I2Cクロック       | 同上。                                                                    |
| **AD0** | アドレス選択          | I2Cでは、**接地(GND)するとアドレス0x68**、**VCCにするとアドレス0x69** になる。|
| **INT** | 割り込み出力          | モーションイベントなどの割り込み信号。GPIOピンに接続して使用可能。             |

### I2C通信およびSSH接続の有効化

```text
$ sudo raspi-config
```
`3 Interface Options    Configure connections to peripherals`を選択する。

<img src="fig/raspi-config_1.svg" width= "650px" >

まず、SSHを有効にするため、`I2 SSH           Enable/disable remote command line access using SSH`を選択する。

<img src="fig/raspi-config_2.svg" width= "650px" >

はいを選択しEnter。

<img src="fig/raspi-config_3.svg" width= "650px" >

了解でEnter。

<img src="fig/raspi-config_4.svg" width= "650px" >

次にI2Cを有効にするため、`I5 I2C           Enable/disable automatic loading of I2C kernel module`を選択する。

はいを選択しEnter。

<img src="fig/raspi-config_5.svg" width= "650px" >

了解でEnter。

<img src="fig/raspi-config_6.svg" width= "650px" >

最初の画面に戻りFinishを選択いEnter。
その後、再起動する。

### カメラモジュールの比較

| 特性                     | **Camera Module v2**                        | **Camera Module v3**                           |
|--------------------------|---------------------------------------------|------------------------------------------------|
| 搭載センサー              | Sony IMX219                                 | Sony IMX708                                    |
| 解像度                   | 8メガピクセル(3280×2464)                     | 12メガピクセル(4608×2592)                       |
| 最大動画解像度            | 1080p(1920×1080)                            | 最大 4608×2592                                 |
| 最大フレームレート        | 1080p @ 30fps                               | 1080p @ 60fps / 4608×2592 @ 30fps              |
| フォーカス               | 固定フォーカス                                | オートフォーカス(通常モデル)                     |
| HDR対応                  | 非対応                                      | 対応(HDRモード搭載)                             |
| ピクセルサイズ            | 1.12μm                                      | 1.4μm(暗所性能向上)                             |
| センサーサイズ            | 1/4インチ                                   | 1/2.43インチ                                    |
| 視野角(FOV)              | 約62.2度                                    | 約76度(通常モデル)、最大120度(広角モデル)         |
| レンズ形式               | 固定(交換不可)                               | M12マウント対応モデルあり                        |
| I2C接続とリボンケーブル   | CSI(15ピン)                                 | CSI(15ピン、互換性あり)                          |
| 推奨用途                 | 基本的な画像処理、教育用、小規模プロジェクト    | 高画質撮影、暗所性能、機械学習、ビデオストリーム    |

### Raspberry Piのスペック表

|項目|Raspberry Pi<br>3A+|Raspberry Pi<br>3B+|Raspberry Pi<br>Zero(無印)|Raspberry Pi<br>Zero 2 W|Raspberry Pi<br>4B|Raspberry Pi<br>5|
|-----|-----|-----|-----|-----|-----|-----|
|CPU|Broadcom BCM2837B0,<br>1.4GHz クアッドコア<br>ARM Cortex-A53|Broadcom BCM2837B0,<br>1.4GHz クアッドコア<br>ARM Cortex-A53|Broadcom BCM2835,<br>ARM1176JZF-S|Broadcom BCM2710A1,<br>1GHz クアッドコア<br>ARM Cortex-A53|Broadcom BCM2711,<br>1.5GHz クアッドコア<br>ARM Cortex-A72|Broadcom BCM2712,<br>3.0GHz クアッドコア<br>ARM Cortex-A76|
|GPU|Broadcom<br>VideoCore IV|Broadcom<br>VideoCore IV|Broadcom<br>VideoCore IV|Broadcom<br>VideoCore IV|Broadcom<br>VideoCore VI|Broadcom<br>VideoCore VII|
|RAM|512MB<br>LPDDR2|1GB<br>LPDDR2|512MB<br>LPDDR2|512MB<br>LPDDR2|2GB/4GB/8GB<br>LPDDR4-3200|4GB/8GB/16GB<br>LPDDR4X|
|CPUクロック|1.4GHz|1.4GHz|1.0GHz|1.0GHz|1.5GHz|3.0GHz|
|H.264ハードウェア<br>エンコード|対応(最大1080p30)|対応(最大1080p60)|対応(最大1080p30)|対応(最大1080p30)|対応(最大4K30)|対応(最大4K60)|
|I2C SCLクロック|最大 1.0GHz(CPU)|最大 1.0GHz(CPU)|最大 400kHz(CPU)|最大 1.0GHz(CPU)|最大 1.5GHz(CPU)|最大 1.5GHz(CPU)|
|消費電力|約 2.5W<br>(待機時:約 0.5W)|約 3.7W<br>(待機時:約 0.5W)|約 0.4\~1.0W<br>(利用状況に依存)|約 1.5W<br>(待機時:約 0.2W)|約 5W<br>(待機時:約 1W)|約 8W<br>(待機時:約 2W)|
|アンペアアワー|約 1.0A<br>(フル稼働時)|約 1.5A<br>(フル稼働時)|約 0.08\~0.2Ah<br>(5V 時)|約 1.0A<br>(フル稼働時)|約 3A<br>(フル稼働時)|約 4A<br>(フル稼働時)|
|H.264ハードウェア<br>デコード|対応<br>(最大1080p30)|対応<br>(最大1080p60)|対応<br>(最大1080p30)|対応<br>(最大1080p30)|対応<br>(最大4K30)|対応<br>(最大4K60)|
|Bluetooth|Bluetooth 4.2|Bluetooth 4.2|非搭載|Bluetooth 4.2|Bluetooth 5.0|Bluetooth 5.2|
|Wi-Fi|802.11n Wi-Fi|802.11ac Wi-Fi(2.4GHz/5GHz)|非搭載|802.11n Wi-Fi|2.4GHz/5GHz Wi-Fi|802.11ac/802.11ax Wi-Fi|
|カメラ接続|CSIカメラポート<br>(カメラモジュール使用可能)|CSIカメラポート<br>(カメラモジュール使用可能)|CSIカメラポート<br>(要変換ケーブル)|CSIカメラポート<br>(カメラモジュール使用可能)|CSIカメラポート<br>(カメラモジュール使用可能)|CSIカメラポート<br>(カメラモジュール使用可能)|
|ディスプレイ接続|HDMI<br>(標準HDMI)|HDMI<br>(標準HDMI)|mini HDMI<br>(最大1080p)|なし<br>(HDMI出力にはマイクロHDMIが必要)|2 x micro HDMI<br>(最大4K30対応)|2 x micro HDMI<br>(最大4K60対応)|
|イーサネット|なし(Wi-Fi使用)|10/100 Mbps イーサネット|非搭載<br>(USB→有線LANアダプタ利用可)|なし(Wi-Fi使用)|Gigabit Ethernet|Gigabit Ethernet|
|電源供給|microUSB 5V<br>(標準供給:2.5A)|microUSB 5V<br>(標準供給:2.5A)|micro USB<br>(5V 1A 推奨)|microUSB 5V<br>(標準供給:2.5A)|USB-C 5V<br>(標準供給:3A)|USB-C 5V<br>(標準供給:4A)|
|消費電流(アイドル時)|約 0.3A|約 0.4A|約 80\~120mA|約 0.2A|約 0.6A|約 0.8A|
|消費電流(高負荷時)|約 1.5A|約 2.0A|約 150\~200mA|約 1.2A|約 2.5A|約 3.5A|
|電流換算(1時間使用時)|約 1.0Ah|約 1.2Ah|約 0.1\~0.2Ah|約 0.8Ah|約 2.0Ah|約 3.0Ah|

### MS-LB3 Smart Mobile Batteryスペック表

|項目|詳細|
|----|----|
|製品名|MS-LB3 Smart Mobile Battery|
|メーカー|milestone(マイルストーン)|
|容量|3,400mAh|
|電圧|3.7V|
|出力電圧|5V(USBポート出力)|
|出力電流|最大 2.1A|
|エネルギー容量|12.58Wh|
|重量|約50g|
|サイズ|直径:65mm、高さ:25mm|
|出力ポート|USB Type-C(付属ケーブル経由でUSB-A出力対応)|
|充電時間|約3.5時間でフル充電|
|発売日|2022年7月中旬|
|備考|急速充電(PD)非対応、残量インジケーターあり(緑色点灯)|

### BM280のスペック表

|項目|内容|
|----|----|
|測定項目|温度、湿度、気圧|
|供給電圧(VDD)|1.71V\~3.6V|
|I/O電圧(VDDIO)|1.2V\~3.6V(通常はVDDと同じに接続)|
|消費電流|通常動作時：\~0.6 μA(1Hzモード)スリープ時:0.1 μA|
|通信インターフェース|I2C、SPI(最大3.4 MHz)|
|I2Cアドレス|0x76 または 0x77(SDOピンの接続で切替)|
|動作温度範囲|-40°C\~+85°C|
|動作湿度範囲|0%\~100% RH(結露なし)|
|動作気圧範囲|300 hPa\~1100 hPa(高度で約0m\~9000mに相当)|

### MPU6050のスペック表

|項目|内容|
|----|----|
|測定項目|3軸加速度 + 3軸角速度(ジャイロ)|
|通信インターフェース|I2C(標準)補助用I2Cスレーブバス(別センサ接続用)|
|I2Cアドレス|0x68(AD0ピン=Low)または 0x69(AD0ピン=High)|
|供給電圧(VDD)|2.375V\~3.46V(通常は3.3V)|
|I/Oレベル|1.8V\~VDD(プルアップ必須)|
|消費電流|約3.9mA(動作時)スリープ時：約5μA|
|内蔵DMP|Digital Motion Processor(姿勢推定・センサフュージョン可能)|
|温度センサー|内蔵あり(粗精度)|
|動作温度範囲|-40°C\~+85°C|

### 消費電力の見積り

MS-LB3 Smart Mobile Batteryを使用した想定での消費電力を見積もる。
- バッテリー容量:3,400mAh(=3.4Ah)
- 電圧変換ロス考慮(実効効率 約85%):実使用可能容量≒2.9Ah

- バッテリーのワット時(Wh)を算出
```math
3.4Ah×3.7V=12.58Wh
```
- Raspberry Pi Zero 2Wの電源供給5Vに対してモバイルバッテリーの電圧を昇圧し共有する。
  - 昇圧に伴う変換効率は一般的に85%で残り15%は熱として失われる。
  - 実効使用可能エネルギー(実際に利用できるエネルギー)は以下のように算出できる。
```math
12.58Wh×0.85≒10.7Wh
```
- Raspberry Pi Zero 2 Wの稼働時間
  - Raspberry Pi Zero 2 Wの消費電力は以下のようになる。
    - アイドル時:0.14A\~0.2A
    - 軽負荷時:0.3A\~0.4A
    - 高負荷時:0.5A\~0.6A
  - 稼働時間は以下のように算出できる。
```math
稼働時間[h]=\frac{バッテリー容量[Ah]}{消費電力[A]}
```

|状態|消費電力 (W)|消費電流 (A)|稼働時間 (時間)|
|--|--|--|--|
|アイドル時|0.7W\~1W|0.14A\~0.2A|約17\~24時間|
|軽負荷時|1.5W\~2W|0.3A\~0.4A|約8.5\~11.3時間|
|高負荷時|2.5W\~3W|0.5A\~0.6A|約5.7\~6.8時間|

※計算結果は理論値で温度など外的要因で影響を受ける。


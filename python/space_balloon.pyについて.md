# space_balloon.pyについて

## 変更履歴

| 日付 | 変更概要 |
|-----------------------------------------------|--------------------|
| 2025/04/30 | 新規作成 |
|  |  |

## 1. space_balloon.py概要

### 1-1. 機能概要

space_balloon.pyは以下機能を提供する。
センサーからデータを取得しcsv形式で出力する機能。
センサーから取得したデータを解析し加工する機能。

### 1-2. クラス構成

space_balloon.pyのクラス構成を以下に示す。

<img src="fig/Class_structure.svg" width= "500px" >

### 1-3. 入出力

space_balloon.pyは実行開始時および実行中に有効機能に応じて以下を入力とする。

- モード選択
- 機能イネーブル
- 機能別パラメータ
- 出力格納先
-  センサー計測データ

次に実行結果として以下を出力する。

- センサー計測データ
- センサー計測加工後データ

#### 1-3-1. 実行オプション

前述した入力は実行オプションで設定する。
以下にオプション一覧を示す。

| オプション             | 説明                                                                 |
|------------------------|----------------------------------------------------------------------|
| `-t <ミリ秒>`          | 撮影時間をミリ秒単位で指定します。例: `-t 10000` は10秒間の撮影。 |
| `-o <ファイル名>`      | 出力ファイル名を指定します。例: `-o video.h264`。             |
| `--width <幅>`         | 動画の幅(ピクセル)を指定します。例: `--width 1920`。        |

#### 1-3-3. csvファイルおよびDataFrame

csvファイルについてセンサー取得モード時はオプションで有効設定にしたセンサーから取得したデータを出力する。センサーデータ解析モードでは解析対象をオプションで設定し、それに応じて加工したcsvを出力する。
また、Excelでの出力オプションを有効にすることで、Excelファイルとして出力可能。
後述する[1-4. 動作モード](#1-4-動作モード)にcsvの形式を示している。

#### 1-3-2. 動画ファイル

動画ファイルについてセンサー取得モード時はカメラモジュールから取得したデータをもとに動画を出力する。一方、センサーデータ解析モードは加工した動画を出力する。加工には読み込んだcsvファイルから取得したデータを動画に埋め込む。

以下は、カメラモジュールから取得したデータを表している。

<img src="fig/Photo_captured_using_a_camera module.svg" width= "500px" >

以下は、カメラモジュールの出力csvおよび他センサーデータ計測データをカメラモジュールから取得したデータに埋め込んだ結果を表している。

<img src="fig/Frame_from_an_edited_video.svg" width= "500px" >

### 1-4. 動作モード

#### 1-4-1.センサー取得モード

センサー取得モードでは、オプションに応じて以下を取得する。
- カメラモジュールからH264フォーマットの動画
- 動画の1フレーム毎のタイムスタンプ
- BME280の計測温度、気圧および湿度
- MPU6050の計測加速度、角速度および温度

##### 1-4-1-1. 動画取得

以下はカメラモジュールの出力csvは以下で、*センサー取得モード*時に出力する。
先頭行にカメラモジュールバージョンがログ説明が必ず入る。
なお、後述する[4. カメラモジュールを用いた動画取得について](#4-カメラモジュールを用いた動画取得について)の[4-3. Pythonコードの説明](#4-3-pythonコードの説明)に記載してあるように、libcamera-vidのオプションで出力するログの形式となる。
このcsvはlibcamera-vidで撮影した動画における1フレームあたりの撮影時間をミリ秒で表している。

```text
# timecode format v2
               0.000
              33.327
              66.655
              99.981
             133.308
                 ...
            6032.182
            6065.511
            6098.837
            6132.164
            6165.490
```

##### 1-4-1-2. BME280計測データ取得

以下はBME280の出力csvは以下で、*センサー取得モード*時に出力する。
- elapsed_timeは初回計測開始からの経過時間を秒単位で表している。
- start_epoch_timeは初回計測開始時刻のUNIXエポックタイムを表している。
- unix_epoch_timeはcsv出力可能時刻のUNIXエポックタイムを表している。
- temperatureはBME280から取得した温度、pressureは気圧、humidityは湿度を表している。

```text
elapsed_time  start_epoch_time  unix_epoch_time  temperature    pressure   humidity
    0.021416      1.745854e+09     1.745854e+09    28.675836  998.101465  39.258262
    0.041374      1.745854e+09     1.745854e+09    28.680888  998.030453  39.078561
    0.062080      1.745854e+09     1.745854e+09    28.690990  998.101007  38.806262
    0.082345      1.745854e+09     1.745854e+09    28.690990  998.074434  38.768136
    0.102556      1.745854e+09     1.745854e+09    28.685939  998.039157  39.231050
         ...               ...              ...          ...         ...        ...
    8.797503      1.745854e+09     1.745854e+09    28.766757  998.018973  38.931588
    8.818225      1.745854e+09     1.745854e+09    28.751604  998.019438  38.779058
    8.838896      1.745854e+09     1.745854e+09    28.766757  998.045549  38.969718
    8.859625      1.745854e+09     1.745854e+09    28.756655  998.081292  39.018731
    8.880499      1.745854e+09     1.745854e+09    28.751604  998.125739  39.726741
```

##### 1-4-1-3. MPU6050計測データ取得

以下はMPU6050の出力csvは以下で、*センサー取得モード*時に出力する。
- elapsed_timeは初回計測開始からの経過時間を秒単位で表している。
- start_epoch_timeは初回計測開始時刻のUNIXエポックタイムを表している。
- unix_epoch_timeはcsv出力可能時刻のUNIXエポックタイムを表している。
- ax、ayおよびazはMPU6050から取得した加速度を表している。
- gx、gyおよびgzはMPU6050から取得した角速度を表している。
- temperatureはMPU6050から取得した温度を表している。

```text
elapsed_time  start_epoch_time  unix_epoch_time        ax        ay        az        gx        gy        gz  temperature
    0.009498      1.745854e+09     1.745854e+09  0.351196 -0.060059  0.898926 -0.900763 -0.404580 -6.946565    31.202941
    0.016580      1.745854e+09     1.745854e+09  0.351196 -0.058350  0.898682 -0.954198 -0.450382 -6.908397    31.217647
    0.025280      1.745854e+09     1.745854e+09  0.352661 -0.054321  0.897217 -0.984733 -0.427481 -7.061069    31.214706
    0.032365      1.745854e+09     1.745854e+09  0.350098 -0.060059  0.895630 -1.007634 -0.564885 -7.160305    31.205882
    0.038829      1.745854e+09     1.745854e+09  0.348267 -0.058716  0.898438 -1.083969 -0.549618 -7.229008    31.200000
         ...               ...              ...       ...       ...       ...       ...       ...       ...          ...
    8.856019      1.745854e+09     1.745854e+09  0.353149 -0.058105  0.893433 -1.068702 -0.557252 -6.984733    31.232353
    8.865768      1.745854e+09     1.745854e+09  0.353027 -0.059204  0.895630 -1.145038 -0.511450 -7.053435    31.250000
    8.873570      1.745854e+09     1.745854e+09  0.350464 -0.057861  0.898926 -1.091603 -0.473282 -7.122137    31.255882
    8.883144      1.745854e+09     1.745854e+09  0.351685 -0.058472  0.900635 -1.213740 -0.534351 -7.175573    31.229412
    8.891014      1.745854e+09     1.745854e+09  0.352417 -0.058472  0.897705 -1.175573 -0.534351 -7.137405    31.241176
```

##### 1-4-1-4. MPU9250計測データ取得

MPU9250は生産終了に伴い未実装となっている。

#### 1-4-2.センサーデータ解析モード

センサーデータ解析モードでは、オプションに応じて以下を取得する。
- カメラモジュールからH264フォーマットの動画
- 動画の1フレーム毎のタイムスタンプ
- BME280の計測温度、気圧および湿度
- MPU6050の計測加速度、角速度および温度

##### 1-4-2-1. 高度の算出

以下は*センサーデータ解析モード*時に出力する、BME280計測結果を加工したcsvである。
*センサー取得モード*時に出力したcsvに高度を追加している。
- current_timeは、BME280から*センサー取得モード*時に取得したunix_epoch_timeを日時・時刻形式にした結果を表している。
- altitudeは、BME280*センサー取得モード*時に取得した温度、気圧および湿度をもとに算出した高度を表している。

なお、高度の算出はに示す。

```text
elapsed_time  start_epoch_time  unix_epoch_time             current_time  temperature    pressure   humidity    altitude
    0.021416      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.168    28.675836  998.101465  39.258262  132.894387
    0.041374      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.188    28.680888  998.030453  39.078561  133.523423
    0.062080      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.209    28.690990  998.101007  38.806262  132.905097
    0.082345      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.229    28.690990  998.074434  38.768136  133.139654
    0.102556      1.745854e+09     1.745854e+09  2025-04-29 00:21:54.249    28.685939  998.039157  39.231050  133.448827
         ...               ...              ...                      ...          ...         ...        ...         ...
    8.797503      1.745854e+09     1.745854e+09  2025-04-29 00:22:02.944    28.766757  998.018973  38.931588  133.662778
    8.818225      1.745854e+09     1.745854e+09  2025-04-29 00:22:02.965    28.751604  998.019438  38.779058  133.651959
    8.838896      1.745854e+09     1.745854e+09  2025-04-29 00:22:02.985    28.766757  998.045549  38.969718  133.428124
    8.859625      1.745854e+09     1.745854e+09  2025-04-29 00:22:03.006    28.756655  998.081292  39.018731  133.108075
    8.880499      1.745854e+09     1.745854e+09  2025-04-29 00:22:03.027    28.751604  998.125739  39.726741  132.713458
```

##### 1-4-2-2. BME280から取得したデータのグラフ作成機能

matplotlibライブラリで出力するようにする予定だが、今回は未実装となっている。

##### 1-4-2-3. MPU6050から取得したデータのグラフ作成機能

matplotlibライブラリで出力するようにする予定だが、今回は未実装となっている。

##### 1-4-2-4. MPU9250から取得したデータのグラフ作成機能

matplotlibライブラリで出力するようにする予定だが、今回は未実装となっている。

##### 1-4-2-5. 動画データとセンサーデータの同期

以下は*センサーデータ解析モード*時に出力する、カメラモジュールの出力csvおよびBME280計測結果をマージしたcsvである。
- current_timeは、カメラモジュールの出力csvから*センサー取得モード*時に取得したunix_epoch_timeを日時・時刻形式にした結果を表している。
- マージデータはBME280の*センサー取得モード*時のcsvから抽出し、unix_epoch_timeが近いデータを表している。
  - 近いデータの抽出には、--toleranceオプションで指定した許容差分範囲以内のデータを抽出する。
  - --toleranceオプションで指定した許容差分に収まるデータが無い場合計測データがないと判断し空欄となる。
- bme280_unix_epoch_time_deltaはカメラモジュールの出力csvおよびBME280の*センサー取得モード*時のcsvにおけるunix_epoch_timeから差分を表している。
  - 例えば、bme280_unix_epoch_time_deltaが0.001412であると、カメラモジュールから取得した時刻とBME280からデータを取得した時刻は1.4msecの時間差があることを表している。

なお、今回の例はBME280だが、MPU6050など他センサーの計測結果もマージ可能である。

```text
milli_sec_elapsed_time  sec_elapsed_time  unix_epoch_time             current_time  bme280_elapsed_time  ...  bme280_unix_epoch_time  bme280_temperature  bme280_pressure  bme280_humidity  bme280_unix_epoch_time_delta
                 0.000          0.000000     1.745854e+09  2025-04-29 00:21:55.150             1.001782  ...            1.745854e+09           28.721297       997.993792        38.740915                      0.001412
                33.327          0.033327     1.745854e+09  2025-04-29 00:21:55.183             1.045655  ...            1.745854e+09           28.721297       998.020366        38.986017                      0.009134
                66.655          0.066655     1.745854e+09  2025-04-29 00:21:55.216             1.067328  ...            1.745854e+09           28.716246       998.038235        39.209310                      0.002522
                99.981          0.099981     1.745854e+09  2025-04-29 00:21:55.250             1.109899  ...            1.745854e+09           28.726348       998.082217        38.659212                      0.006723
               133.308          0.133308     1.745854e+09  2025-04-29 00:21:55.283             1.131053  ...            1.745854e+09           28.721297       998.073513        39.040482                      0.005450
                   ...               ...              ...                      ...                  ...  ...                     ...                 ...              ...              ...                           ...
              6032.182          6.032182     1.745854e+09  2025-04-29 00:22:01.182             7.042190  ...            1.745854e+09           28.751604       998.072588        38.697348                      0.006813
              6065.511          6.065511     1.745854e+09  2025-04-29 00:22:01.215             7.063206  ...            1.745854e+09           28.736450       998.019902        39.242017                      0.005499
              6098.837          6.098837     1.745854e+09  2025-04-29 00:22:01.249             7.104738  ...            1.745854e+09           28.741502       998.002031        38.958802                      0.002707
              6132.164          6.132164     1.745854e+09  2025-04-29 00:22:01.282             7.125377  ...            1.745854e+09           28.746553       998.037310        38.604742                      0.009982
              6165.490          6.165490     1.745854e+09  2025-04-29 00:22:01.315             7.166440  ...            1.745854e+09           28.756655       998.054717        38.294218                      0.002244
```

## 2. 動作環境

#### Raspberry Pi Zero 2 WH

#### Raspberry Pi 4B


## 3. 実行方法

### 3-1. 実行例

## 4. カメラモジュールを用いた動画取得について

カメラモジュールはv2およびv3での2種類で撮影可能である。
v2かv3でPythonスクリプトの差分は発生しないが、今回はv2で撮影した場合の説明で記載する。

### 4-1. センサー取得モード時の動画ファイルおよび出力csvファイル
[1-3-3. csvファイルおよびDataFrame](#1-3-3-csvファイルおよびdataframe)に示すようなcsvファイルを出力する。

### 4-2. センサーデータ解析モード時の動画ファイルおよび出力csvファイル

### 4-3. Pythonコードの説明

## 5. BME280を用いた高度算出について

### 5-1. BME280について

BME280で計測可能なデータは以下である。

| 気圧                                          | 温度               | 湿度                |
|-----------------------------------------------|-------------------|---------------------|
| 単位:ヘクトパスカル(hPa)                       | 単位:℃(摂氏)       | 単位:%(RH)          |
| 計測範囲:300\~1100hPa<br>(標高換算-500~+9000m) | 計測範囲:-40\~+85℃ | 計測範囲:0%\~100%RH |

### 5-2. 高度の算出方法について

高度を求める場合、気圧から算出可能である。
高度の算出には、パラメトリック方程式または等温パラメトリック方程式を使用する。

#### 5-2-1. パラメトリック方程式について

パラメトリック方程式は対流圏といった0km~11kmの範囲で使用する方程式。
成層圏以上では誤差が大きくなる。
理由として、気温が一定の割合で低下すると仮定しているが、成層圏では気温が上昇するためである。

<!--------------------------------------------------------------------------------->

```math
h=
\left( \frac{T}{L} \right)
\left( 1-\left( \frac{P}{P_0} \right)^{\!\!\frac{RL}{gM}} \right)
```

```math
h:高度[m]\hspace{0pt}
```

```math
T:仮想温度または実測温度 [K]\hspace{0pt}
```

```math
L:温度減率(0.0065[K/m])\hspace{0pt}
```

```math
P:測定地点の気圧[hPa]\hspace{0pt}
```

```math
P_0:海面上の標準気圧(1013.25[hPa])\hspace{0pt}
```

```math
R:気体定数(8.314462618[J/(mol·K)])\hspace{0pt}
```

```math
g:重力加速度(9.80665[m/s^2])\hspace{0pt}
```

```math
M:空気のモル質量(0.0289644[kg/mol])\hspace{0pt}
```

<!--------------------------------------------------------------------------------->

#### 5-2-2. 等温パラメトリック方程式について

成層圏といった11km~20kmの範囲で使用する方程式。
成層圏では温度が一定なため、パラメトリック方程式より誤差を抑えられる。

```math
h=11000+\frac{RT}{gM}×ln\left( \frac{P_0}{P} \right)
```

```math
h:高度[m]\hspace{0pt}
```

```math
R:気体定数(8.314462618[J/(mol·K)])\hspace{0pt}
```

```math
T:温度[K]\hspace{0pt}
```

```math
g:重力加速度(9.80665[m/s^2])\hspace{0pt}
```

```math
M:空気のモル質量(0.0289644[kg/mol])\hspace{0pt}
```

```math
P_u:層の下端の気圧(約22632Pa[hPa]\ 11km)\hspace{0pt}
```

```math
P:測定地点の気圧[hPa]\hspace{0pt}
```

<!--------------------------------------------------------------------------------->

#### 5-2-3. 湿度を用いた仮想温度について

湿度を考慮しするため仮想温度を算出することで、高度の算出精度を向上できる。
湿度が高いと空気密度が変化し高度の算出精度が変わるため、湿度を考慮し精度を上げることが可能。
仮想温度を求める上で、混合比、水蒸気圧および飽和水蒸気圧をを用いて求める。

<!--------------------------------------------------------------------------------->

##### 5-2-3-1. 仮想温度(Virtual Temperature)

仮想温度は湿度を考慮し、乾燥空気の密度と等しい密度を持つ理想気体の温度として定義する。
空気が湿っていると密度が下がるため、温度を高く見積もる。
仮想温度は以下式で求める。

```math
T_v=T×\left( 1+0.61×r \right)
```

##### 5-2-3-2. 混合比(Mixing Ratio)

混合比は乾いた空気1gに対して何gの水蒸気が含まれているかを表す。
0.622は水蒸気と乾燥空気の分子量比。

```math
r=\frac{0.622×e}{P-e}
```

##### 5-2-3-3. 水蒸気圧(Vapor Pressure)

実際の空気中の水蒸気圧力は以下の式で求める。
湿度が100%である時eは飽和水蒸気圧の値となり、それ以下の場合は比例して小さくなる。

```math
e=e_s×\left( \frac{RH}{100} \right)
```

<!--------------------------------------------------------------------------------->

##### 5-2-3-4. 飽和水蒸気圧(Saturation Vapor Pressure)

空気は気温が高いほど空気はより多くの水蒸気を保持できる。
飽和水蒸気圧は近似式(Tetensの式)を用いて求められる。
以下に式を示す。

```math
e_s=6.112×exp\left( \frac{17.67×T_c}{T_c-243.5} \right)
```

```math
h:高度[m]\hspace{209pt}
```

```math
P:測定地点の気圧[hPa]\hspace{148pt}
```

```math
P_0:基準地点の気圧(通常は海面気圧=1013.25[hPa])\hspace{24pt}
```

```math
T_0:基準温度(通常は288.15[K])\hspace{82pt}
```

```math
L:気温の lapse rate(気温減率、標準大気では 0.0065[K/m])\hspace{0pt}
```

```math
R:気体定数(287.05[J/(kg·K)])\hspace{121pt}
```

```math
g:重力加速度(9.80665[m/s^2])\hspace{126pt}
```

```math
M:空気のモル質量(0.0289644[kg/mol])\hspace{88pt}
```

<!--------------------------------------------------------------------------------->

### 5-3. Pythonコードの説明

高度算出は以下関数で実施している。
なお、Tc、RH、Pはそれぞれセンサーデー計測した温度、湿度、気圧となっている。

```py
    def __calculate_altitude( self , Tc , RH , P ):
        P0  = 1013.25     # 海面上の標準気圧[hPa]
        L   = 0.0065      # 温度減率[K/m]
        g   = 9.80665     # 重力加速度[m/s^2]
        R   = 8.314462618 # 気体定数[J/(mol·K)]
        M   = 0.0289644   # 空気のモル質量[kg/mol]
        Pu  = 226.32      # 標準大気における11kmの気圧[hPa]
        if RH is None or RH <= 0: # 湿度データが無い場合は実測温度を使う
            Tu = Tc + 273.15 # [K]
        else:                     # 湿度データがある場合は仮想温度を使う
            Tu = self.__virtual_temperature( Tc , RH , P )
        if P > Pu:                # 対流圏 (11km以下)
            h = (Tu / L) * (1 - (P / P0) ** ((R * L) / (g * M)))
        else:                     # 成層圏 (11km以上)
            h = 11000 + ( R * Tu ) / ( g * M ) * math.log( Pu / P )
        return h
```

以下で湿度を用いた仮想温度を算出している。仮想温度算出には飽和水蒸気圧、水蒸気圧および混合比を算出する必要がある。

```py
    def __virtual_temperature( self , Tc , RH , P ):
        Tk  = Tc + 273.15  # 気温をKに変換
        es  = 6.112 * math.exp( (17.67*Tc) / (Tc+243.5) ) # 飽和水蒸気圧(Tetensの式)es[hPa]
        e   = (RH / 100.0) * es                           # 実際の水蒸気圧e[hPa]
        r   = (0.622*e) / (P-e)                           # 混合比r[g/kg]
        Tkv = Tk * ( 1 + 0.61 * r / 1000 )                # 仮想温度[K]
        return Tkv
```

<!--------------------------------------------------------------------------------->
<!-- <img src="figure/sample.svg" width= "300px" > -->
<!--------------------------------------------------------------------------------->

## 6. MPU6050を用いた加速度および角速度の取得について

### 6-1. MPU6050について

MPU6050で計測可能なデータは以下である。

| x軸加速度・y軸加速度・z軸加速度 | x軸角速度・y軸角速度・z軸角速度 | 温度    |
|------------------------------|-------------------------------|---------|
| 単位:g(重力加速度)            | 単位:°/S(度毎秒)               |         |
|  a                           |  a                              |         |

### 6-2. Pythonコードの説明

センサーデータの取得はMPU6050Implクラスで実施している。
以下がセンサーからデータを取得する関数である。
\_\_read\_sensor関数では、I2C通信バス上デバイスアドレスのアドレスを指定しデータを取得する。
MPU6050では、デバイス内部で加速度3種、角速度3種および温度と複数のデータをレジスタから読み取る。

```py
    def __read_sensor( self ):
        PWR_MGMT_1a  = 0x6B
        ACCEL_XOUT_H = 0x3B
        ACCEL_YOUT_H = 0x3D
        ACCEL_ZOUT_H = 0x3F
        GYRO_XOUT_H  = 0x43
        GYRO_YOUT_H  = 0x45
        GYRO_ZOUT_H  = 0x47
        TEMP_OUT_H   = 0x41
        self.__bus.write_byte_data( self.__address , PWR_MGMT_1a , 0 )
        self.__ax          =   self.__read_word( ACCEL_XOUT_H ) / 16384.0
        self.__ay          =   self.__read_word( ACCEL_YOUT_H ) / 16384.0
        self.__az          =   self.__read_word( ACCEL_ZOUT_H ) / 16384.0
        self.__gx          =   self.__read_word( GYRO_XOUT_H  ) / 131.0
        self.__gy          =   self.__read_word( GYRO_YOUT_H  ) / 131.0
        self.__gz          =   self.__read_word( GYRO_ZOUT_H  ) / 131.0
        self.__temperature = ( self.__read_word( TEMP_OUT_H ) + 521 ) / 340.0 + 35.0
```

デバイスから取得する際はレジスタのアドレスを指定し、1バイトのデータを2回取得する。
2回目のデータ取得時はレジスタのアドレスを1加算しずらして別レジスタからデータを取得する。
よって、I2C通信バスへのアクセスは2回行われる。
1回目に取得したデータは加速度、角速度または温度のMSBデータである。
このため\_\_read\_word関数ではMSBにデータを詰めるため、8ビット(1バイト)分算術左シフトしている。
(なお、I2C通信バス向けのread_i2c_block_data関数で一括取得し、バス負荷を軽減できることもある。)

```py
    def __read_word( self , addr ):
        high = self.__bus.read_byte_data( self.__address , addr   )
        low  = self.__bus.read_byte_data( self.__address , addr+1 )
        val = (high << 8) + low
        if( val < 0x8000 ):
            return val
        else:
            return val - 65536
```

## 7. MPU9250を用いた加速度、角速度および地磁気の取得について

現在、MPU9250生産終了のためICM20948に以降予定。

## 8. ICM20948を用いた加速度、角速度および地磁気の取得について

ICM20948入手後、実装および動作確認予定。

## 9. センサーデータ動画およびcsv出力に伴うオーバヘッドの回避


## 10. 今後の課題


## 付録

### Raspberry Pi OSの確認

以下コマンドでDebinanベースのディストリビューションバージョンを確認可能。
Codenameの欄が該当箇所。
例では、Bullseyeとなっているが、2025/04/30時点で1つ古いバージョンとなっており、最新はBookwormとなっている。
BullseyeとBookwormからカメラモジュールの設定ファイルやIPアドレス固定向けファイルの配置場所が変わっている。

```text
$ lsb_release -a
No LSB modules are available.
Distributor ID: Raspbian
Description:    Raspbian GNU/Linux 11 (bullseye)
Release:        11
Codename:       bullseye
```

### Sambaの設定

Raspberry Piで何らかの開発をする場合、Window間-Raspberry Piでファイルのやり取りをすることが多々あるかと思われる。
例えば、出力Excelファイルなどの確認で使用する。
この際にネットワーク経由でファイル共有が可能な場合効率が上がることがあるため、ファイル共有設定を説明する。
なお、実際にバルーン打ち上げ時に余計なプロセスが動作していると消費電力に影響があるため不要な場合は動作しないようにした方が良い。

インストールコマンドは以下。

```text
sudo apt-get install -y samba
```

Sambaの設定は/etc/samba/smb.confに追記する。

```text
$ sudo エディタ(vi、emacsやnanoなど) /etc/samba/smb.conf
```

アカウント名は共有したいユーザディレクトリを記載する。

```text
#                                                                                               
# Sample configuration file for the Samba suite for Debian GNU/Linux.                           
#                                                                                               
#                                                                                               
# This is the main Samba configuration file. You should read the                                
# smb.conf(5) manual page in order to understand the options listed                             
# here. Samba has a huge number of configurable options most of which  

                                 省略

# Windows clients look for this share name as a source of downloadable
# printer drivers
[print$]
   comment = Printer Drivers
   path = /var/lib/samba/printers
   browseable = yes
   read only = yes
   guest ok = no
# Uncomment to allow remote administration of Windows print drivers.
# You may need to replace 'lpadmin' with the name of the group your
# admin users are members of.
# Please note that you also need to set appropriate Unix permissions
# to the drivers directory for these users to have write rights in it
;   write list = root, @lpadmin

[アカウント名]
   comment = アカウント名 user file space
   path = /home/アカウント名
   force user = アカウント名
   guest ok = no
   create mask = 0666
   directory mask = 0777
   read only = no
```

### IPアドレスの固定

Raspberry Pi OSがBullseyeおよびRaspberry Pi Zero 2の前提で説明を記載。

現在のIPアドレスは以下コマンドで調べられる。

```text
$ ifconfig
lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (ローカルループバック)
        RX packets 42  bytes 4920 (4.8 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 42  bytes 4920 (4.8 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

wlan0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.0.67  netmask 255.255.255.0  broadcast 192.168.0.255
        inet6 fe80::db06:eca1:833c:e925  prefixlen 64  scopeid 0x20<link>
        inet6 1455b:10:53c0:3e00:bbbd:bd1:f345:a4a4  prefixlen 64  scopeid 0x0<global>
        ether 省略  txqueuelen 1000  (イーサネット)
        RX packets 72780  bytes 9847351 (9.3 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 95607  bytes 53115827 (50.6 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

wlan0がWi-Fiで接続しているインタフェース名でinetがIPv4アドレスとなっている。
ネットマスクは255.255.255.0で24ビットがネットワーク部となっている。
wlan0のIPアドレスを固定する場合は/etc/dhcp.confをエディタで編集する。
以下に、IPアドレスを192.168.0.55に固定するための記述を示す。

```text
$ sudo エディタ(vi、emacsやnanoなど) /etc/dhcp.conf
```

```text
# A sample configuration for dhcpcd.                                                             
# See dhcpcd.conf(5) for details.                                                                

# Allow users of this group to interact with dhcpcd via the control socket.
#controlgroup wheel

# Inform the DHCP server of our hostname for DDNS.
hostname

                    省略

# fallback to static profile on eth0
#interface eth0
#fallback static_eth0

interface wlan0
static ip_address=192.168.0.55/24
static routers=192.168.0.1
```

interfaceのwlan0の箇所が設定となっている。
static ip_addressで固定するIPアドレスを記載する。
/24はサブネットマスクのネットワーク部ビット数を記載する。
static routersはデフォルトゲートウェイ(ルーター)のIPアドレスを記載する。
一般的に1がルーターのIPアドレスになるが、何らかの理由で異なる場合は以下コマンドで調べる。

```text
$ ip route
default via 192.168.0.1 dev wlan0 src 192.168.0.67 metric 302 
192.168.0.0/24 dev wlan0 proto dhcp scope link src 192.168.0.67 metric 302 
```

default via 192.168.0.1がルーターのIPアドレスとなる。

### カメラモジュールの比較

| 特性                     | **Camera Module v2**                        | **Camera Module v3**                           |
|--------------------------|---------------------------------------------|------------------------------------------------|
| 搭載センサー             | Sony IMX219                                 | Sony IMX708                                    |
| 解像度                   | 8メガピクセル(3280×2464)                  | 12メガピクセル(4608×2592)                    |
| 最大動画解像度           | 1080p(1920×1080)                          | 最大 4608×2592                                 |
| 最大フレームレート       | 1080p @ 30fps                               | 1080p @ 60fps / 4608×2592 @ 30fps              |
| フォーカス               | 固定フォーカス                              | オートフォーカス(通常モデル)                |
| HDR対応                 | 非対応                                     | 対応(HDRモード搭載)                         |
| ピクセルサイズ           | 1.12μm                                      | 1.4μm(暗所性能向上)                          |
| センサーサイズ           | 1/4インチ                                   | 1/2.43インチ                                   |
| 視野角(FOV)            | 約62.2度                                    | 約76度(通常モデル)、最大120度(広角モデル) |
| レンズ形式               | 固定(交換不可)                            | M12マウント対応モデルあり                     |
| I2C接続とリボンケーブル  | CSI(15ピン)                              | CSI(15ピン、互換性あり)                     |
| 推奨用途                 | 基本的な画像処理、教育用、小規模プロジェクト | 高画質撮影、暗所性能、機械学習、ビデオストリーム |

### libcamera-vid オプション一覧

| オプション             | 説明                                                                 |
|------------------------|----------------------------------------------------------------------|
| `-t <ミリ秒>`          | 撮影時間をミリ秒単位で指定します。例: `-t 10000` は10秒間の撮影。 |
| `-o <ファイル名>`      | 出力ファイル名を指定します。例: `-o video.h264`。             |
| `--width <幅>`         | 動画の幅(ピクセル)を指定します。例: `--width 1920`。        |
| `--height <高さ>`      | 動画の高さ(ピクセル)を指定します。例: `--height 1080`。      |
| `--framerate <fps>`    | フレームレート(1秒あたりのフレーム数)を指定します。例: `--framerate 30`。 |
| `--bitrate <bps>`      | ビットレート(1秒あたりのビット数)を指定します。例: `--bitrate 8000000` は8Mbps。 |
| `--codec <形式>`        | エンコード形式を指定します。`h264`(デフォルト)、`mjpeg`、`yuv420` など。例: `--codec mjpeg`。 |
| `--profile <プロファイル>` | H.264 のプロファイルを指定します。`baseline`、`main`、`high` など。 |
| `--level <レベル>`      | H.264 のレベルを指定します。例: `--level 4.1`。                     |
| `--nopreview`  | プレビューウィンドウを表示しません。SSH 接続時などに便利です。       |
| `--fullscreen` | プレビューを全画面表示します。                                       |
| `--qt-preview` | Qt ベースのプレビューウィンドウを使用します。                       |
| `--segment <ミリ秒>`     | 指定した時間ごとに新しいファイルに分割して保存します。例: `--segment 10000` は10秒ごとに分割。 |
| `--inline`               | ストリームに SPS/PPS ヘッダーをインラインで挿入します。ストリーミング時に必要です。 |
| `--listen`               | TCP ストリーミング時にサーバーモードで待機します。                  |                                                         
| `--shutter <マイクロ秒>` | シャッター速度をマイクロ秒単位で指定します。例: `--shutter 20000`。   |
| `--gain <値>`          | アナログゲインを指定します。例: `--gain 1.5`。                       |
| `--awb <モード>`       | 自動ホワイトバランスモードを指定します。例: `--awb auto`。            |
| `--exposure <モード>`  | 露出モードを指定します。例: `--exposure normal`。                     |
| `--verbose`            | 詳細なログ情報を出力します。デバッグ時に有用です。                   |
| `--log-level <レベル>` | ログの出力レベルを指定します。例: `--log-level debug`。            
| `--save-pts <ファイル名>` | 各フレームのタイムスタンプをミリ秒単位で指定したファイルに保存します。例: `--save-pts timestamps.txt`。 |

### Raspberry Piのスペック表

### 消費電力の見積り

### 動画フォーマットおよび容量の比較見積り

### libcamera-vid出力可能なメタデータ

### C++によるlibcameraライブラリ使用による精度向上について
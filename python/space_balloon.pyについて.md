# space_balloon.pyについて



## BME280またはBMP280を用いた高度算出について
### BME280およびBMP280について
BME280で計測可能なデータは以下である。
| 気圧                                          | 温度               | 湿度                |
|-----------------------------------------------|-------------------|---------------------|
| 単位:ヘクトパスカル(hPa)                       | 単位:℃(摂氏)       | 単位:%(RH)          |
| 計測範囲:300\~1100hPa<br>(標高換算-500~+9000m) | 計測範囲:-40\~+85℃ | 計測範囲:0%\~100%RH |

BMP280で計測可能なデータは以下である。
| 気圧                                           | 温度               |
|-----------------------------------------------|--------------------|
| 単位:ヘクトパスカル(hPa)                        | 単位:℃(摂氏)       |
| 計測範囲:300\~1100hPa<br>(標高換算-500\~+9000m) | 計測範囲:-40\~+85℃ |
### 高度の算出方法について
高度を求める場合、気圧から算出可能である。
高度の算出には、パラメトリック方程式または等温パラメトリック方程式を使用する。
#### パラメトリック方程式について
パラメトリック方程式は対流圏といった0km~11kmの範囲で使用する方程式。
成層圏以上では誤差が大きくなる。
理由として、気温が一定の割合で低下すると仮定しているが、成層圏では気温が上昇するためである。

<!--------------------------------------------------------------------------------->

```math
h=
\left( \frac{T}{L} \right)
\left( 1-\left( \frac{P}{P_0} \right)^{\!\!\frac{RL}{gM}} \right)
```
```math
h:高度[m]\hspace{0pt}
```
```math
T:仮想温度または実測温度 [K]\hspace{0pt}
```
```math
L:温度減率(0.0065[K/m])\hspace{0pt}
```
```math
P:測定地点の気圧[hPa]\hspace{0pt}
```
```math
P_0:海面上の標準気圧(1013.25[hPa])\hspace{0pt}
```
```math
R:気体定数(8.314462618[J/(mol·K)])\hspace{0pt}
```
```math
g:重力加速度(9.80665[m/s^2])\hspace{0pt}
```
```math
M:空気のモル質量(0.0289644[kg/mol])\hspace{0pt}
```

<!--------------------------------------------------------------------------------->

#### 等温パラメトリック方程式について
成層圏といった11km~20kmの範囲で使用する方程式。
成層圏では温度が一定なため、パラメトリック方程式より誤差を抑えられる。
```math
h=11000+\frac{RT}{gM}×ln\left( \frac{P_0}{P} \right)
```
```math
h:高度[m]\hspace{0pt}
```
```math
R:気体定数(8.314462618[J/(mol·K)])\hspace{0pt}
```
```math
T:温度[K]\hspace{0pt}
```
```math
g:重力加速度(9.80665[m/s^2])\hspace{0pt}
```
```math
M:空気のモル質量(0.0289644[kg/mol])\hspace{0pt}
```
```math
P_0:層の下端の気圧(約22632Pa[hPa]\ 11km)\hspace{0pt}
```
```math
P:測定地点の気圧[hPa]\hspace{0pt}
```
<!--------------------------------------------------------------------------------->

#### 湿度を用いた仮想温度について
湿度を考慮しするため仮想温度を算出することで、高度の算出精度を向上できる。
湿度が高いと空気密度が変化し高度の算出精度が変わるため、湿度を考慮し精度を上げることが可能。
仮想温度を求める上で、混合比、水蒸気圧および飽和水蒸気圧をを用いて求める。

<!--------------------------------------------------------------------------------->
##### 仮想温度(Virtual Temperature)
仮想温度は湿度を考慮し、乾燥空気の密度と等しい密度を持つ理想気体の温度として定義する。
空気が湿っていると密度が下がるため、温度を高く見積もる。

```math
T_v=T×\left( 1+0.61×r \right)
```

##### 混合比(Mixing Ratio)
```math
r=\frac{0.622×e}{P-e}
```

##### 水蒸気圧(Vapor Pressure)
```math
e=e_s×\left( \frac{RH}{100} \right)
```
<!--------------------------------------------------------------------------------->

##### 飽和水蒸気圧(Saturation Vapor Pressure)
空気は気温が高いほど空気はより多くの水蒸気を保持できる。
飽和水蒸気圧は近似式(Tetensの式)を用いて求められる。
```math
e_s=6.112×exp\left( \frac{17.67×T_c}{T_c-243.5} \right)
```
```math
h:高度[m]\hspace{209pt}
```
```math
P:測定地点の気圧[hPa]\hspace{148pt}
```
```math
P_0:基準地点の気圧(通常は海面気圧=1013.25[hPa])\hspace{24pt}
```
```math
T_0:基準温度(通常は288.15[K])\hspace{82pt}
```
```math
L:気温の lapse rate(気温減率、標準大気では 0.0065[K/m])\hspace{0pt}
```
```math
R:気体定数(287.05[J/(kg·K)])\hspace{121pt}
```
```math
g:重力加速度(9.80665[m/s^2])\hspace{126pt}
```
```math
M:空気のモル質量(0.0289644[kg/mol])\hspace{88pt}
```

<!--------------------------------------------------------------------------------->

#### Pythonコードの説明
altitude_bme280.pyおよびaltitude_bmp280.pyで上記パラメータを使用は以下のように設定している。
```py
# 定数
P0 = 1013.25    # 海面上の標準気圧[hPa]
L = 0.0065      # 温度減率[K/m]
g = 9.80665     # 重力加速度[m/s^2]
R = 8.314462618 # 気体定数[J/(mol・K)]
M = 0.0289644   # 空気のモル質量[kg/mol]
P11 = 226.32    # 標準大気における11kmの気圧[hPa]
```
高度算出は以下関数で実施している。
なお、T0は固定値ではなくセンサー計測値になっている。
BME280では湿度も計測できるため、仮想温度を用いた温度算出をしている。
```py
def calculate_altitude( T_c, RH, P ):
    if RH is None or RH <= 0: # 湿度データが無い場合は実測温度を使う
        T_u = T_c + 273.15  # [K]
    else:                     # 湿度データがある場合は仮想温度を使う
        T_u = virtual_temperature( T_c , RH , P )
    if P > P11:               # 対流圏 (11km以下)
        h = (T_u / L) * (1 - (P / P0) ** ((R * L) / (g * M)))
    else:                     # 成層圏 (11km以上)
        h = 11000 + ( R * T_u ) / ( g * M ) * math.log( P11 / P )
    return h
```

```py
def virtual_temperature( T_c , RH , P ):
    T  = T_c + 273.15  # 気温をKに変換
    es = 6.112 * math.exp( (17.67*T_c) / (T_c+243.5) ) # 飽和水蒸気圧(Tetensの式)es[hPa]
    e  = (RH / 100.0) * es                             # 実際の水蒸気圧e[hPa]
    r  = (0.622*e) / (P-e)                             # 混合比r[g/kg]
    Tv = T * ( 1 + 0.61 * r / 1000 )                   # 仮想温度[K]
    return Tv
```

<!--------------------------------------------------------------------------------->

BMP280は湿度が計測できないため、仮想温度は使用しない。
```py
def calculate_altitude(temp_c, pressure_hpa):
    T = temp_c + 273.15  # Kに変換
    if pressure_hpa > 226.32:  # 高度約11,000mより下（対流圏）
        altitude = (T / L) * (1 - (pressure_hpa / P0) ** (R * L / (g*M))
    else:  # 成層圏（11km 以上）、温度一定の仮定で指数式
        # 成層圏基準値（高度11kmの条件）
        h0 = 11000
        P1 = 226.32  # [hPa]
        altitude = h0 + ( (R*T) / (g*M) ) * math.log(P1/pressure_hpa)
```

<!--------------------------------------------------------------------------------->

<!-- <img src="figure/sample.svg" width= "300px" > -->

<!--------------------------------------------------------------------------------->